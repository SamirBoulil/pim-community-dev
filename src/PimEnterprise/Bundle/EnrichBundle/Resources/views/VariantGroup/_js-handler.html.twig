<script type="text/javascript">
    require(
        ['jquery', 'underscore', 'pim/optionform', 'pim/scopable', 'pim/currencyfield', 'datepicker', 'pim/dialog', 'pim/dialogform', 'oro/mediator', 'backbone/bootstrap-modal', 'jquery.select2'],
        function ($, _, optionform, Scopable, CurrencyField, datepicker, Dialog, DialogForm, mediator) {
            'use strict';

            $(function () {
                _.each($('a.add-attribute-option'), function(optionLink) {
                    optionform.init('#' + optionLink.getAttribute('id'));
                });

                _.each($('form div.scopable:not(.currency)'), function (field) {
                    new Scopable({ el: $(field) });
                });

                _.each($('form div.currency'), function (field) {
                    new CurrencyField({ el: $(field) });
                });

                _.each($('form input.datepicker:not(.hasPicker)'), function (field) {
                    datepicker.init(field.getAttribute('id'));
                });

                mediator.trigger('pim:reinit');

                // Current value popover
                $('.from-smart[data-async-content]').on('mouseover', function() {
                    var $this = $(this);
                    var url = $this.data('async-content');

                    $this.attr('data-content', '{{ "pimee_catalog_rule.product.tooltip.loading.title"|trans }}');
                    $this.popover({'html': true});
                    $this.popover('show');

                    $this.off('mouseover');
                    $.get(url, function(data) {
                        var codes = [];
                        for (var key in data) {
                            codes.push(data[key].code);
                        }

                        var message = "{{ "pimee_catalog_rule.product.tooltip.variant_affected_by_a_rule.content"|trans|capitalize|raw }}";
                        message = message.replace('%rule%', codes.join(', '));

                        $this.attr('data-content', message)
                            .popover('destroy')
                            .popover({'html': true})
                            .popover('show');
                    });
                });
            });
        }
    );
</script>
